#!/bin/bash
# piper-speak-install - Download Piper voice models
# Usage: piper-speak-install [voice-name]
#
# Available voices: https://huggingface.co/rhasspy/piper-voices

set -e

PIPER_VOICE_DIR="${PIPER_VOICE_DIR:-$HOME/.local/share/piper/voices}"
BASE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main"

# Voice mappings: name -> path
declare -A VOICES=(
    ["en_US-lessac-medium"]="en/en_US/lessac/medium"
    ["en_US-lessac-high"]="en/en_US/lessac/high"
    ["en_US-amy-medium"]="en/en_US/amy/medium"
    ["en_US-ryan-medium"]="en/en_US/ryan/medium"
    ["en_US-ryan-high"]="en/en_US/ryan/high"
    ["en_GB-alan-medium"]="en/en_GB/alan/medium"
    ["en_GB-alba-medium"]="en/en_GB/alba/medium"
)

list_voices() {
    echo "Available voices:"
    for voice in "${!VOICES[@]}"; do
        if [ -f "$PIPER_VOICE_DIR/$voice.onnx" ]; then
            echo "  $voice (installed)"
        else
            echo "  $voice"
        fi
    done
    echo ""
    echo "For more voices, see: https://huggingface.co/rhasspy/piper-voices"
}

download_voice() {
    local voice="$1"
    local path="${VOICES[$voice]}"

    if [ -z "$path" ]; then
        echo "Error: Unknown voice '$voice'" >&2
        echo "Use 'piper-speak-install --list' to see available voices" >&2
        exit 1
    fi

    if [ -f "$PIPER_VOICE_DIR/$voice.onnx" ]; then
        echo "Voice '$voice' is already installed"
        return 0
    fi

    mkdir -p "$PIPER_VOICE_DIR"
    echo "Downloading $voice..."

    curl -L "$BASE_URL/$path/$voice.onnx" -o "$PIPER_VOICE_DIR/$voice.onnx"
    curl -L "$BASE_URL/$path/$voice.onnx.json" -o "$PIPER_VOICE_DIR/$voice.onnx.json"

    echo "Installed: $voice"
}

# Parse arguments
case "${1:-}" in
    --list|-l)
        list_voices
        ;;
    --help|-h)
        echo "Usage: piper-speak-install [voice-name]"
        echo "       piper-speak-install --list"
        echo ""
        echo "Downloads Piper voice models to ~/.local/share/piper/voices"
        echo ""
        echo "Default voice: en_US-lessac-medium"
        ;;
    "")
        download_voice "en_US-lessac-medium"
        ;;
    *)
        download_voice "$1"
        ;;
esac
