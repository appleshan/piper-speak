#!/bin/bash
# speak-selection - Read selected text aloud using Piper TTS
# Uses primary selection (highlighted text) on Wayland
#
# Features:
#   - Toggle behavior: press hotkey again to stop speaking
#   - Uses wl-paste to get highlighted text
#
# Suggested keybinding (Hyprland):
#   bind = SUPER SHIFT, period, exec, speak-selection

SESSION_MARKER="/tmp/piper-speak-session"
LOCK_FILE="/tmp/piper-speak-lock"

# Use a lock to prevent race conditions with rapid hotkey presses
exec 200>"$LOCK_FILE"
flock -n 200 || exit 0  # Exit if another instance is running

# Toggle behavior: if speaking, stop and exit
if [ -f "$SESSION_MARKER" ]; then
    rm -f "$SESSION_MARKER"
    pkill -9 -f "piper-tts" 2>/dev/null
    pkill -9 -f "pw-play.*/tmp/piper-speak" 2>/dev/null
    sleep 0.1
    exit 0
fi

# Get primary selection (highlighted text)
text=$(wl-paste --primary 2>/dev/null)

if [ -z "$text" ]; then
    notify-send -t 2000 "Speak Selection" "No text selected" 2>/dev/null || true
    exit 0
fi

echo "$text" | piper-speak --speed 0.8 --bg
