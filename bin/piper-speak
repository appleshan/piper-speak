#!/bin/bash
# piper-speak - Simple Piper TTS wrapper
# Usage: echo "text" | piper-speak [--speed NUM] [--bg]
#        piper-speak "text to speak"
#
# Options:
#   --speed  Length scale (default: 0.7, lower = faster)
#   --bg     Run in background

PIPER_VOICE="${PIPER_VOICE:-en_US-lessac-medium}"
SPEED="0.7"
BACKGROUND=false
TEXT=""

# Voice search paths (user dir first, then system)
USER_VOICE_DIR="${PIPER_VOICE_DIR:-$HOME/.local/share/piper/voices}"
SYSTEM_VOICE_DIR="/usr/share/piper-speak/voices"

while [[ $# -gt 0 ]]; do
    case $1 in
        --speed) SPEED="$2"; shift 2 ;;
        --bg) BACKGROUND=true; shift ;;
        --voice) PIPER_VOICE="$2"; shift 2 ;;
        --help|-h)
            echo "Usage: echo \"text\" | piper-speak [options]"
            echo "       piper-speak [options] \"text to speak\""
            echo ""
            echo "Options:"
            echo "  --speed NUM   Length scale (default: 0.7, lower = faster)"
            echo "  --bg          Run in background"
            echo "  --voice NAME  Voice model name (default: en_US-lessac-medium)"
            echo ""
            echo "Environment:"
            echo "  PIPER_VOICE_DIR  User voice directory (default: ~/.local/share/piper/voices)"
            echo "  PIPER_VOICE      Default voice model name"
            echo ""
            echo "Voice models are loaded from user dir first, then /usr/share/piper-speak/voices"
            exit 0
            ;;
        -*) echo "Unknown option: $1" >&2; exit 1 ;;
        *) TEXT="$1"; shift ;;
    esac
done

# Find voice model (check user dir first, then system)
if [ -f "$USER_VOICE_DIR/$PIPER_VOICE.onnx" ]; then
    VOICE_PATH="$USER_VOICE_DIR/$PIPER_VOICE.onnx"
elif [ -f "$SYSTEM_VOICE_DIR/$PIPER_VOICE.onnx" ]; then
    VOICE_PATH="$SYSTEM_VOICE_DIR/$PIPER_VOICE.onnx"
else
    echo "Error: Voice model not found: $PIPER_VOICE" >&2
    echo "Run 'piper-speak-install $PIPER_VOICE' to download it" >&2
    exit 1
fi

speak() {
    local text="$1"
    local tmp_wav="/tmp/piper-speak-$$.wav"

    [ -z "$text" ] && return

    echo "$text" | piper-tts --model "$VOICE_PATH" --length_scale "$SPEED" \
        --output_file "$tmp_wav" >/dev/null 2>&1 && pw-play "$tmp_wav"

    rm -f "$tmp_wav"
}

# Get text from argument or stdin
if [ -z "$TEXT" ]; then
    TEXT=$(cat)
fi

if [ -z "$TEXT" ]; then
    echo "Error: No text provided" >&2
    exit 1
fi

if $BACKGROUND; then
    speak "$TEXT" >/dev/null 2>&1 &
else
    speak "$TEXT"
fi
