#!/bin/bash
# speak-selection - Read selected text aloud using Piper TTS
# Uses primary selection (highlighted text) on Wayland
#
# Features:
#   - Toggle behavior: press hotkey again to stop speaking
#   - Uses xclip to get highlighted text
#
# Suggested keybinding (Hyprland):
#   bind = SUPER SHIFT, period, exec, speak-selection

# Kill any existing piper-speak process (toggle behavior)
# Use -x for exact match on process name to avoid matching shell commands
if pkill -x "piper-speak" 2>/dev/null; then
    pkill -f "piper-tts.*piper.*voices" 2>/dev/null
    pkill -f "pw-play.*/tmp/piper-speak" 2>/dev/null
    exit 0
fi

# Get primary selection (highlighted text)
text=$(xclip -o 2>/dev/null)

if [ -z "$text" ]; then
    notify-send -t 2000 "Speak Selection" "No text selected" 2>/dev/null || true
    exit 0
fi

echo "$text" | piper-speak --bg --voice en_US-ryan-high --speed 1.6
